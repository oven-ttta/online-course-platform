generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum Role {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum CourseStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonType {
  VIDEO
  TEXT
  QUIZ
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EnrollmentStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

// ==================== MODELS ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  avatarUrl     String?   @map("avatar_url")
  phone         String?
  bio           String?
  role          Role      @default(STUDENT)
  isActive      Boolean   @default(true) @map("is_active")
  isVerified    Boolean   @default(false) @map("is_verified")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  courses         Course[]        @relation("InstructorCourses")
  enrollments     Enrollment[]
  payments        Payment[]
  reviews         Review[]
  lessonProgress  LessonProgress[]
  quizAttempts    QuizAttempt[]
  refreshTokens   RefreshToken[]
  wishlist        Wishlist[]

  @@map("users")
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  token      String   @unique
  expiresAt  DateTime @map("expires_at")
  deviceInfo String?  @map("device_info")
  ipAddress  String?  @map("ip_address")
  isRevoked  Boolean  @default(false) @map("is_revoked")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  courseId  String   @map("course_id")
  createdAt DateTime @default(now()) @map("created_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("wishlists")
}

model Contact {
  id        String   @id @default(uuid())
  name      String
  email     String
  subject   String
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("contacts")
}

model Coupon {
  id            String    @id @default(uuid())
  code          String    @unique
  description   String?
  discountType  String    @map("discount_type") // PERCENTAGE or FIXED
  discountValue Decimal   @map("discount_value") @db.Decimal(10, 2)
  minAmount     Decimal?  @map("min_amount") @db.Decimal(10, 2)
  maxDiscount   Decimal?  @map("max_discount") @db.Decimal(10, 2)
  startDate     DateTime  @map("start_date")
  endDate       DateTime  @map("end_date")
  usageLimit    Int?      @map("usage_limit")
  usedCount     Int       @default(0) @map("used_count")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@map("coupons")
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  slug        String    @unique
  description String?
  iconUrl     String?   @map("icon_url")
  parentId    Int?      @map("parent_id")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Self-relation for subcategories
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")

  courses     Course[]

  @@map("categories")
}

model Course {
  id               String       @id @default(uuid())
  instructorId     String       @map("instructor_id")
  categoryId       Int          @map("category_id")
  title            String
  slug             String       @unique
  description      String
  shortDescription String?      @map("short_description")
  thumbnailUrl     String?      @map("thumbnail_url")
  previewVideoUrl  String?      @map("preview_video_url")
  price            Decimal      @db.Decimal(10, 2)
  discountPrice    Decimal?     @map("discount_price") @db.Decimal(10, 2)
  level            CourseLevel  @default(BEGINNER)
  language         String       @default("th")
  requirements     String[]
  whatYouLearn     String[]     @map("what_you_learn")
  totalDuration    Int          @default(0) @map("total_duration")
  totalLessons     Int          @default(0) @map("total_lessons")
  status           CourseStatus @default(DRAFT)
  isFeatured       Boolean      @default(false) @map("is_featured")
  publishedAt      DateTime?    @map("published_at")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  instructor       User              @relation("InstructorCourses", fields: [instructorId], references: [id])
  category         Category          @relation(fields: [categoryId], references: [id])
  sections         Section[]
  lessons          Lesson[]
  enrollments      Enrollment[]
  payments         Payment[]
  reviews          Review[]
  statistics       CourseStatistics?
  wishlist         Wishlist[]

  @@index([instructorId])
  @@index([categoryId])
  @@index([status])
  @@map("courses")
}

model Section {
  id          String   @id @default(uuid())
  courseId    String   @map("course_id")
  title       String
  description String?
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
  @@map("sections")
}

model Lesson {
  id            String     @id @default(uuid())
  sectionId     String     @map("section_id")
  courseId      String     @map("course_id")
  title         String
  type          LessonType
  content       String?
  videoUrl      String?    @map("video_url")
  videoDuration Int?       @map("video_duration")
  attachments   Json?
  sortOrder     Int        @default(0) @map("sort_order")
  isFree        Boolean    @default(false) @map("is_free")
  isPublished   Boolean    @default(false) @map("is_published")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  section        Section          @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  quiz           Quiz?
  lessonProgress LessonProgress[]

  @@index([sectionId])
  @@index([courseId])
  @@map("lessons")
}

model Quiz {
  id               String   @id @default(uuid())
  lessonId         String   @unique @map("lesson_id")
  passingScore     Int      @default(70) @map("passing_score")
  timeLimit        Int?     @map("time_limit")
  maxAttempts      Int?     @map("max_attempts")
  shuffleQuestions Boolean  @default(false) @map("shuffle_questions")
  createdAt        DateTime @default(now()) @map("created_at")

  lesson    Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@map("quizzes")
}

model QuizQuestion {
  id             String   @id @default(uuid())
  quizId         String   @map("quiz_id")
  question       String
  questionType   String   @default("single") @map("question_type")
  options        Json
  correctAnswers Json     @map("correct_answers")
  explanation    String?
  points         Int      @default(1)
  sortOrder      Int      @default(0) @map("sort_order")

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@map("quiz_questions")
}

model Enrollment {
  id              String           @id @default(uuid())
  userId          String           @map("user_id")
  courseId        String           @map("course_id")
  paymentId       String?          @map("payment_id")
  enrolledAt      DateTime         @default(now()) @map("enrolled_at")
  expiresAt       DateTime?        @map("expires_at")
  progressPercent Decimal          @default(0) @map("progress_percent") @db.Decimal(5, 2)
  completedAt     DateTime?        @map("completed_at")
  status          EnrollmentStatus @default(ACTIVE)
  createdAt       DateTime         @default(now()) @map("created_at")

  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         Course           @relation(fields: [courseId], references: [id])
  payment        Payment?         @relation(fields: [paymentId], references: [id])
  lessonProgress LessonProgress[]
  quizAttempts   QuizAttempt[]
  review         Review?

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

model LessonProgress {
  id           String    @id @default(uuid())
  enrollmentId String    @map("enrollment_id")
  lessonId     String    @map("lesson_id")
  userId       String    @map("user_id")
  isCompleted  Boolean   @default(false) @map("is_completed")
  watchTime    Int       @default(0) @map("watch_time")
  lastPosition Int       @default(0) @map("last_position")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
  @@map("lesson_progress")
}

model QuizAttempt {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  quizId       String    @map("quiz_id")
  enrollmentId String    @map("enrollment_id")
  score        Decimal   @db.Decimal(5, 2)
  totalPoints  Int       @map("total_points")
  isPassed     Boolean   @map("is_passed")
  answers      Json
  startedAt    DateTime  @map("started_at")
  submittedAt  DateTime? @map("submitted_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz       Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model Payment {
  id                    String        @id @default(uuid())
  userId                String        @map("user_id")
  courseId              String        @map("course_id")
  amount                Decimal       @db.Decimal(10, 2)
  currency              String        @default("THB")
  paymentMethod         String        @map("payment_method")
  paymentProvider       String        @map("payment_provider")
  providerTransactionId String?       @map("provider_transaction_id")
  status                PaymentStatus @default(PENDING)
  paidAt                DateTime?     @map("paid_at")
  metadata              Json?
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id])
  course      Course       @relation(fields: [courseId], references: [id])
  enrollments Enrollment[]
  receipt     Receipt?

  @@index([userId])
  @@index([courseId])
  @@index([status])
  @@map("payments")
}

model Receipt {
  id            String   @id @default(uuid())
  paymentId     String   @unique @map("payment_id")
  receiptNumber String   @unique @map("receipt_number")
  taxId         String?  @map("tax_id")
  companyName   String?  @map("company_name")
  address       String?
  subtotal      Decimal  @db.Decimal(10, 2)
  taxAmount     Decimal  @default(0) @map("tax_amount") @db.Decimal(10, 2)
  total         Decimal  @db.Decimal(10, 2)
  issuedAt      DateTime @default(now()) @map("issued_at")
  pdfUrl        String?  @map("pdf_url")
  createdAt     DateTime @default(now()) @map("created_at")

  payment Payment @relation(fields: [paymentId], references: [id])

  @@map("receipts")
}

model Review {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  courseId        String    @map("course_id")
  enrollmentId    String    @unique @map("enrollment_id")
  rating          Int
  comment         String?
  isApproved      Boolean   @default(true) @map("is_approved")
  instructorReply String?   @map("instructor_reply")
  repliedAt       DateTime? @map("replied_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([rating])
  @@map("reviews")
}

model CourseStatistics {
  id               String   @id @default(uuid())
  courseId         String   @unique @map("course_id")
  totalEnrollments Int      @default(0) @map("total_enrollments")
  totalReviews     Int      @default(0) @map("total_reviews")
  averageRating    Decimal  @default(0) @map("average_rating") @db.Decimal(3, 2)
  totalRevenue     Decimal  @default(0) @map("total_revenue") @db.Decimal(12, 2)
  updatedAt        DateTime @default(now()) @map("updated_at")

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("course_statistics")
}
